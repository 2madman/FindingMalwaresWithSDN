import re
from scapy.all import sniff, DNS, DNSQR, TCP, IP, Raw, packet
from collections import defaultdict
from datetime import datetime, timedelta
import base64


found = False

# Dictionary to store the count of DNS queries per IP per minute
dns_queries = defaultdict(int)
query_times = defaultdict(lambda: datetime.now())

# Parameters for detection
EXCESSIVE_LIMIT = 100  # Threshold for excessive DNS queries per minute
LONG_SUBDOMAIN_THRESHOLD = 70  # Length threshold for what constitutes a long subdomain

executable_header = re.compile(b'MZ')
script_shebang = re.compile(b'#!/bin/bash')

obfuscated_js_pattern = re.compile(rb"\W(eval|function|var)\W.*\W(window|document|eval|function|var)\W", re.I)
base64_pattern = re.compile(rb'(?:(?:[A-Za-z0-9+/]{4})*(?:[A-Za-z0-9+/]{2}==|[A-Za-z0-9+/]{3}=)?)')

def packet_callback(packet):
    if packet.haslayer(TCP) and packet.haslayer(Raw):
        payload = packet[Raw].load
        src_ip = packet[IP].src
        dst_ip = packet[IP].dst

        # Check for JavaScript obfuscation
        if obfuscated_js_pattern.search(payload):
            print(f"Obfuscated JavaScript detected in traffic from {src_ip} to {dst_ip}")

        # Check for base64 encoded data
        if base64_pattern.fullmatch(payload.strip()):
            try:
                decoded_data = base64.b64decode(payload.strip())
                if decoded_data and re.match(rb'^[\x20-\x7E]*$', decoded_data) is None:
                    print(f"Base64 encoded payload detected in traffic from {src_ip} to {dst_ip}")
                    found = True
            except:
                pass  


def payload_analysis(packet):
    if IP in packet and TCP in packet and Raw in packet:
        payload = packet[Raw].load
        check_payload(payload)

def check_payload(payload):
    if executable_header.search(payload):
        print("Executable file detected.")
    if script_shebang.search(payload):
        print("Bash script detected.")

def jsObfuscationBase64encoded():
    print("Starting HTTP payload monitoring...")
    sniff(filter="tcp port 80", prn=packet_callback, store=False)


def commonPattFunc():
    payload_analysis()
    jsObfuscationBase64encoded()
    return found