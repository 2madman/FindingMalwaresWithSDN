from scapy.layers.inet import IP
from scapy.layers.inet import TCP
from scapy.all import *
import threading
import time

# Global variable to track if malware is detected
malware_detected = False

# Define the detection function
def detection(packet):
    global malware_detected
    if TCP in packet and (packet[TCP].dport in [445, 139, 80]):
        if Raw in packet:
            payload = packet[Raw].load
            data = b"infpub.dat"
            if data in payload:
                print(f"Malware Detected in packet from {packet[IP].src} to {packet[IP].dst} {payload}")
                malware_detected = True
                return True
    return False

# Define a callback function for sniffing that uses the detection function
def packet_callback(packet):
    if detection(packet):
        print(f"Malicious packet detected: {packet}")
        return True

# Main function to run the script
def detect():
    global malware_detected
    malware_detected = False  # Reset the malware detection flag

    # List available interfaces
    interfaces = get_if_list()

    # Define the interface to sniff on
    interface = "\\Device\\NPF_Loopback"  # Update with your interface name

    # Verify if the interface is valid
    if interface not in interfaces:
        print(f"Error: Interface {interface} not found.")
        return

    # Function to stop sniffing after a timeout
    def stop_sniffing(sniffer):
        if sniffer.running:
            print("Stopping sniffing...")
            sniffer.stop()
        else:
            print("Sniffer was already stopped.")

    # Start sniffing in a separate thread using async_sniff
    sniffer = AsyncSniffer(iface=interface, prn=packet_callback, stop_filter=lambda x: malware_detected, count=1000)
    sniffer.start()

    # Create a timer to stop sniffing after 3 seconds
    timer = threading.Timer(3, stop_sniffing, [sniffer])
    timer.start()

    # Wait for the sniffer thread to finish
    sniffer.join()

    return malware_detected

# Example usage
if __name__ == "__main__":
    result = detect()
    print(f"Malware detected: {result}")
